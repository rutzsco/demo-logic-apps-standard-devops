# ----------------------------------------------------------------------------------------------------
# Template to deploy a logic app standard to a Function App
# ----------------------------------------------------------------------------------------------------
parameters: 
  stageName: ''
  stageDisplayName: ''
  variableGroupName: ''
  azureSubscription: ''
  environment: ''
  triggerFrequency: ''
  artifactName: ''

# ----------------------------------------------------------------------------------------------------
stages:
  - stage: ${{ parameters.stageName }}
    displayName: ${{ parameters.stageDisplayName }}

    jobs:
    - deployment: logic_app_deploy
      displayName: 'Deploy Logic App'
      environment: ${{ parameters.environment }}

      variables:
      - group: ${{ parameters.variableGroupName }}
      - name: stageName
        value: ${{ parameters.stageName }}
      - name: environment
        value: ${{ parameters.environment }}
      - name: triggerFrequency
        value: ${{ parameters.triggerFrequency }}
      - name: artifactFolderName
        value: 'App'

      strategy:
        runOnce:
          deploy:
            steps:
            - bash: |
                echo "azureSubscription=$(azureSubscription)"
                echo "azureSubscriptionId=$(azureSubscriptionId)"
                echo "region=$(region)"
                echo "resourceGroupName=$(resourceGroupName)"
                echo "environment=$(environment)"
                echo "appPrefix=$(appPrefix)"
                echo "logicAppName=$(logicAppName)"
                echo "storageAccountName=$(storageAccountName)"
                echo "triggerFrequency=$(triggerFrequency)"
                echo "Pipeline.Workspace=$(Pipeline.Workspace)"
                tree $(Pipeline.Workspace)
              displayName: 'Display Variables'
              continueOnError: true

            - task: AzureFunctionApp@1
              displayName: 'Deploy Logic App Zip'
              retryCountOnTaskFailure: 2
              inputs:
                azureSubscription: $(azureSubscription)
                appType: 'functionApp'
                appName: $(logicAppName)
                package: '$(Pipeline.Workspace)/$(artifactFolderName)/$(artifactName)'
                deploymentMethod: 'zipDeploy'
                AppSettings: '-WORKFLOWS_SUBSCRIPTION_ID $(azureSubscriptionId) -WORKFLOWS_LOCATION_NAME $(region) -WORKFLOWS_RESOURCE_GROUP_NAME $(resourceGroupName) -STORAGE_ACCOUNT_NAME  $(storageAccountName) -TRIGGER_FREQUENCY $(triggerFrequency)'